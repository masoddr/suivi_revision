{% extends "base.html" %}

{% block title %}Exercices - Suivi des révisions{% endblock %}

{% block content %}
<div class="exercises-header">
    <h1>Mes Exercices</h1>
    <button id="resetButton" class="btn btn-danger">
        <i class="bi bi-arrow-counterclockwise"></i>
        <span>Réinitialiser</span>
            </button>
        </div>

<!-- Version Desktop -->
<div class="card subjects-grid desktop-only">
    {% for sujet in sujets %}
    <div class="subject-card">
        <div class="subject-header">
            <h3>{{ sujet.nom }}</h3>
            {% if sujet.lien %}
            <a href="{{ sujet.lien }}" target="_blank" class="btn btn-primary btn-sm">
                <i class="bi bi-file-earmark-text"></i>
                <span>Voir le sujet</span>
            </a>
            {% endif %}
    </div>

        <div class="exercises-list">
                    {% for i in range(1, 5) %}
                        {% set exercice = sujet.exercices.get(i) %}
                        {% if exercice %}
            <div class="exercise-item">
                <div class="exercise-check">
                            <input type="checkbox" 
                           id="ex-{{ exercice.id }}"
                                   data-id="{{ exercice.id }}"
                                   {% if exercice.complete %}checked{% endif %}
                                   onclick="updateExercice(this)">
                    <label for="ex-{{ exercice.id }}">Exercice {{ i }}</label>
                        </div>
                <div class="exercise-themes">
                    {% for theme in exercice.themes.split(',') %}
                    <span class="badge">{{ theme.strip() }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
                {% endfor %}
        </div>
    </div>
    {% endfor %}
    </div>

    <!-- Version Mobile -->
<div class="mobile-subjects mobile-only">
            {% for sujet in sujets %}
    <div class="card subject-card-mobile">
        <div class="subject-header-mobile" onclick="toggleExercices(this)">
            <div class="header-content">
                    <h3>{{ sujet.nom }}</h3>
                <div class="toggle-icon">
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            {% if sujet.lien %}
            <a href="{{ sujet.lien }}" target="_blank" class="btn btn-primary btn-sm">
                <i class="bi bi-file-earmark-text"></i>
                <span>Voir le sujet</span>
            </a>
            {% endif %}
        </div>
        
        <div class="exercises-list-mobile">
                    {% for i in range(1, 5) %}
                    {% set exercice = sujet.exercices.get(i) %}
                    {% if exercice %}
            <div class="exercise-item-mobile">
                <div class="exercise-check">
                            <input type="checkbox" 
                           id="ex-mobile-{{ exercice.id }}"
                                   data-id="{{ exercice.id }}"
                                   {% if exercice.complete %}checked{% endif %}
                                   onclick="updateExercice(this)">
                    <label for="ex-mobile-{{ exercice.id }}">Exercice {{ i }}</label>
                </div>
                <div class="exercise-themes">
                    {% for theme in exercice.themes.split(',') %}
                    <span class="badge">{{ theme.strip() }}</span>
                    {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
</div>

<!-- Boîte de dialogue de confirmation -->
<div id="confirmDialog" class="dialog-overlay">
    <div class="dialog-content">
        <h3>Confirmation</h3>
        <p>Êtes-vous sûr de vouloir réinitialiser votre progression ?</p>
        <div class="dialog-buttons">
            <button id="cancelReset" class="btn btn-secondary">Annuler</button>
            <button id="confirmReset" class="btn btn-danger">Confirmer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* En-tête de la page */
.exercises-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.exercises-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--gray-800);
}

/* Grille des sujets */
.subjects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.subject-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.subject-header {
    padding: 1rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.subject-header h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-800);
}

/* Liste des exercices */
.exercises-list {
    padding: 1rem;
}

.exercise-item {
    padding: 0.75rem;
    border-radius: var(--border-radius);
    transition: background-color 0.2s ease;
}

.exercise-item:hover {
    background-color: var(--gray-50);
}

.exercise-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.exercise-check input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 4px;
    border: 2px solid var(--gray-400);
    cursor: pointer;
    transition: all 0.2s ease;
}

.exercise-check input[type="checkbox"]:checked {
    background-color: var(--success);
    border-color: var(--success);
}

.exercise-check label {
    font-weight: 500;
    color: var(--gray-700);
    cursor: pointer;
}

.exercise-themes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-left: 1.75rem;
}

.badge {
    padding: 0.25rem 0.5rem;
    background-color: var(--gray-100);
    color: var(--gray-600);
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Version Mobile */
.mobile-only {
    display: none;
}

.subject-card-mobile {
    margin-bottom: 1rem;
}

.subject-header-mobile {
    padding: 1rem;
    cursor: pointer;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.toggle-icon i {
    transition: transform 0.3s ease;
}

.exercises-list-mobile {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.exercise-item-mobile {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--gray-200);
}

/* Boîte de dialogue */
.dialog-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 100;
    align-items: center;
    justify-content: center;
}

.dialog-overlay.show {
    display: flex;
}

.dialog-content {
    background: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    max-width: 400px;
    width: 90%;
}

.dialog-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 1rem;
}

.dialog-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
}

/* Notifications et animations */
.notification {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    padding: 1rem;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    z-index: 50;
    animation: slideIn 0.3s ease;
}

.notification.success {
    border-left: 4px solid var(--success);
}

.notification.error {
    border-left: 4px solid var(--danger);
}

.achievement {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    text-align: center;
    z-index: 100;
    animation: popIn 0.5s ease;
}

.achievement-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.achievement-message {
    font-size: 1.25rem;
    font-weight: 500;
    color: var(--gray-800);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes popIn {
    from {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
    }
    to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
}

/* Responsive */
@media screen and (max-width: 768px) {
    .desktop-only {
        display: none;
    }
    
    .mobile-only {
        display: block;
    }
    
    .exercises-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
    <script>
    function updateExercice(element) {
        const id = element.dataset.id;
        const complete = element.checked;
        
        if (complete) {
            createFirework();
        showEncouragement();
    }
        
        updateExerciceStatus(id, complete);
    }

    function createFirework() {
        const firework = document.createElement('div');
        firework.className = 'firework';
        document.body.appendChild(firework);
        
        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const angle = (i / 50) * 360;
            const velocity = 2 + Math.random() * 2;
            particle.style.setProperty('--angle', angle + 'deg');
            particle.style.setProperty('--velocity', velocity);
            particle.style.setProperty('--hue', Math.random() * 360);
            firework.appendChild(particle);
        }
        
        setTimeout(() => firework.remove(), 2000);
    }

function showEncouragement() {
    const messages = [
        "Bravo ! Continue comme ça ! 🌟",
        "Excellent travail ! 🎉",
        "Tu es sur la bonne voie ! 💪",
        "Un pas de plus vers la réussite ! 🚀",
        "Super progression ! 🌈",
        "Tu gères ! 🏆",
        "Continue sur ta lancée ! ⭐",
        "Très bon travail ! 🎯"
    ];
    const message = messages[Math.floor(Math.random() * messages.length)];
    
    showNotification(message);
    }

    function showAchievement(message) {
        const achievement = document.createElement('div');
        achievement.className = 'achievement';
        achievement.innerHTML = `
            <div class="achievement-icon">🏆</div>
            <div class="achievement-message">${message}</div>
        `;
        document.body.appendChild(achievement);
        setTimeout(() => achievement.remove(), 5000);
    }

    function toggleExercices(element) {
    const card = element.closest('.subject-card-mobile');
    const exercicesList = card.querySelector('.exercises-list-mobile');
    const toggleIcon = card.querySelector('.toggle-icon i');
        
        if (exercicesList.style.maxHeight) {
            exercicesList.style.maxHeight = null;
            toggleIcon.style.transform = 'rotate(0deg)';
        } else {
            exercicesList.style.maxHeight = exercicesList.scrollHeight + "px";
            toggleIcon.style.transform = 'rotate(180deg)';
        }
    }

    function updateExerciceStatus(exerciceId, complete) {
        fetch('/update_exercice', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: exerciceId,
                complete: complete
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Déclencher l'événement de mise à jour de la progression
                const event = new CustomEvent('progressUpdated', {
                    detail: {
                        progress: data.progress
                    }
                });
                document.dispatchEvent(event);
                
                // Vérifier si l'annale est complète
                checkAnnaleComplete(exerciceId);
            }
        })
        .catch(error => console.error('Erreur:', error));
    }

function checkAnnaleComplete(exerciceId) {
    const checkbox = document.querySelector(`input[data-id="${exerciceId}"]`);
    const subjectCard = checkbox.closest('.subject-card') || checkbox.closest('.subject-card-mobile');
    const subjectTitle = subjectCard.querySelector('h3').textContent;
    
    fetch('/check_annale_complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sujet: subjectTitle })
    })
    .then(response => response.json())
    .then(data => {
        if (data.complete) {
            showAchievement(data.message);
        }
    })
    .catch(error => console.error('Erreur lors de la vérification:', error));
}

function showNotification(message, isError = false) {
    const notification = document.createElement('div');
    notification.className = `notification ${isError ? 'error' : 'success'}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Gestionnaires d'événements pour la réinitialisation
const resetButton = document.getElementById('resetButton');
const confirmDialog = document.getElementById('confirmDialog');
const cancelReset = document.getElementById('cancelReset');
const confirmReset = document.getElementById('confirmReset');

resetButton.addEventListener('click', () => {
    confirmDialog.classList.add('show');
});

cancelReset.addEventListener('click', () => {
    confirmDialog.classList.remove('show');
});

confirmReset.addEventListener('click', () => {
    confirmDialog.classList.remove('show');
    resetProgress();
});

confirmDialog.addEventListener('click', (e) => {
    if (e.target === confirmDialog) {
        confirmDialog.classList.remove('show');
    }
});

function resetProgress() {
    fetch('/reset_progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            showNotification("Réinitialisation effectuée avec succès !");
        } else {
            showNotification("Erreur lors de la réinitialisation.", true);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification("Erreur lors de la réinitialisation.", true);
    });
}

// Ajouter un écouteur d'événements pour les mises à jour de progression
document.addEventListener('progressUpdated', function(event) {
    // Propager l'événement au parent (page d'accueil) si elle existe
    if (window.parent && window.parent !== window) {
        window.parent.document.dispatchEvent(new CustomEvent('progressUpdated', {
            detail: event.detail
        }));
    }
});
</script>
{% endblock %} 